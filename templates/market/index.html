{% extends "index.html" %}


{% block content %}

    <section class="section is-family-monospace" id="analyze">
        <div class="field has-addons has-addons-centered">
            <label class="label" for="symbol">Select Symbol:</label>
            <div class="control">
                <div class="select">
                    <select id="symbol">
                        {% for symbol in symbols %}
                            <option base="{{ symbol.base.name }}" quote="{{ symbol.quote.name }}">{{ symbol }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="field has-addons has-addons-centered">
            <label class="label" for="exchange">Select Exchange:</label>
            <div class="control">
                <div class="select">
                    <select id="exchange">
                        {% for exchange in exchanges %}
                            <option name="{{ exchange.name }}">{{ exchange }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="field is-grouped is-grouped-centered">
            <div class="control">
                <button class="button is-link is-danger is-rounded" id="analyzeBtn">Analyze</button>
            </div>
        </div>

    </section>

    <div id="result">

    </div>

{% endblock %}

{% block script %}
    var analyzeButton = document.getElementById("analyzeBtn");
    var resultSection = document.getElementById("result");
    function toggleLoading() {
        analyzeButton.classList.toggle("is-loading");
    }

    analyzeButton.addEventListener('click', (e) => {
        toggleLoading();
        resultSection.innerHTML = "";
        var symbol = document.getElementById("symbol");
        var exchange = document.getElementById("exchange");
        var symbolSelection = symbol.options[symbol.selectedIndex];
        var exchangeSelection = exchange.options[exchange.selectedIndex];
        console.log(symbolSelection.getAttribute('base'));
        console.log(symbolSelection.getAttribute('quote'));
        console.log(exchangeSelection.getAttribute('name'));
        var formData = new FormData();
        formData.append("base", symbolSelection.getAttribute('base'));
        formData.append("quote", symbolSelection.getAttribute('quote'));
        formData.append("exchange", exchangeSelection.getAttribute('name'));
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
        fetch(
            "{% url "market-analyze" %}",
            {
                body: formData,

                method: 'POST',
            }
        ).then(function(response) {
                return response.json();
            })
            .then(function(myJson) {
                console.log(myJson);
                console.log(myJson.html);
{#                alert(`${myJson.before} ==> ${myJson.after}`)#}

{#                var image = document.createElement("img");#}
{#                image.setAttribute("height", "360");#}
{#                image.setAttribute("width", "640");#}
{#                image.src = myJson.element;#}
{#                document.getElementById("analyze").appendChild(image);#}
                var r = new DOMParser().parseFromString(myJson.html, "text/html")
                resultSection.innerHTML = r.body.innerHTML;
                toggleLoading();
            });
    });
{% endblock %}
